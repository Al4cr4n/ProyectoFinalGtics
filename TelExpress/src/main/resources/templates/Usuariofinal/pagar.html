<!DOCTYPE html>

<html
        lang="es"
        class="light-style layout-menu-fixed"
        dir="ltr"
        data-theme="theme-default"
        data-assets-path="../../assets/"
        data-template="vertical-menu-template-free"
>
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
    />

    <title> Productos- CoordinadorZonal</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../../assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
            rel="stylesheet"
    />

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="../../assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="../../assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="../../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="../../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="../../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <link rel="stylesheet" href="../../assets/vendor/libs/apex-charts/apex-charts.css" />

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="../../assets/vendor/js/helpers.js"></script>


    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="../../assets/js/config.js"></script>

    <!--TelExpress fuente de letra-->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos personalizados -->
    <!-- Custom stlylesheet -->
    <link type="text/css" rel="stylesheet" href="../../assets/css/style_products.css"/>

    <!-- fuentes FA -->
    <link type="text/css" rel="stylesheet" href="../../assets/css/font-awesome.min.css"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.3/font/bootstrap-icons.min.css">

    <!--uso de token dinamico-->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .btn {
            height: 100%;
            display: flex;
            align-items: center;
        }
        .btn-group {
            display: flex;
            flex-wrap: nowrap;
            }
        .btn .icon-image {
            width: 40px;
            height: 40px;
        }

            /*.icono-check {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 100px;
                height: 100px;
                background-color: #8fce51; /* Verde claro *
                border-radius: 50%;
            }*/
            
        .icono-check svg {
            width: 50px;
            height: 50px;
            fill: white; /* Check blanco */
        }

        .icono-check i {
            font-size: 100px; /* Tamaño del ícono */
            color: #79e97de3; /* Verde claro (puedes cambiar el color aquí)*/
        }
    </style>
    <style>
        /* Oculta el texto cuando la pantalla tiene entre 576px y 768px */
        @media (min-width: 768px) and (max-width: 990px) {
            .btn-text {
                display: none;
            }
        }
    </style>

</head>

<body>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <div th:insert="~{Usuariofinal/fragments/menu.html::menu}"></div> <!-- este es el menu -->

        <!-- Layout container -->
        <div class="layout-page">
            <div th:insert="~{Usuariofinal/fragments/navbar.html::navbar}"></div> <!-- este es el navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->
                <div class="container-xxl flex-grow-1 container-p-y">
                    <h4 class="desing-title-page">Zona Oeste</h4>
                    <div id="alerta-errores" class="alert alert-danger d-none" role="alert">
                        <!-- Aquí se insertará el mensaje de error dinámicamente -->
                    </div>
                    <div class="card">
                        <div class="row">
                        <div class="col-md-7" style="border-right: 1px solid #dee2e6;">
                            <div class="card-header row g-3 align-items-center justify-content-between ">
                                <!--<div class=" row g-3 align-items-center">-->
                                    <!--<div class="row ">-->
                                    <div class="col-md-4 col-lg-5">
                                        <button id="checkbox1" class="btn btn-outline-secondary d-flex align-items-center w-100">
                                        <!--<input type="checkbox" id="checkbox1" class="checkbox me-4">-->
                                        <!--<label for="checkbox1" class="d-flex align-items-center gap-4 form-check-label">-->
                                            <!--<a href="../../assets/img/icons/unicons/visa.png" target="_blank" class="icon-link me-2">
                                            <img src="../../assets/img/icons/unicons/visa.png" alt="Icono" class="icon-image">
                                            </a>-->
                                            <img src="../../assets/img/icons/unicons/visa.png" alt="Icono" class="icon-image">
                                            <span class="btn-text">Tarjeta</span>
                                        <!--</label>-->
                                        </button>
                                    </div>
                                
                                    <div class="col-md-4 col-lg-5 align-items-center justify-content-between ">
                                        <button id="checkbox2" class="btn btn-outline-secondary d-flex align-items-center w-100">
                                        <!--<input type="checkbox" id="checkbox2" class="checkbox me-4">-->
                                        <label for="checkbox2" class="d-flex align-items-center gap-4 form-check-label">
                                            <!--<a href="../../assets/img/icons/unicons/paypal.png" target="_blank" class="icon-link me-2">-->
                                            <img src="../../assets/img/icons/unicons/paypal.png" alt="Icono" class="icon-image">
                                            <!--</a>-->
                                            <span class="btn-text">PayPal</span>
                                        </label>
                                        </button>
                                    </div>
                                    <!--</div>-->
                                <!--</div>-->
                            </div>
                            <hr class="m-0">
                            <div class="card-body">
                                <h3 >Detalles de Compra</h3>
                                <form id="pagoForm" method="POST">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                        <label for="correo" class="form-label">Correo</label>
                                        <input
                                            type="email"
                                            class="form-control"
                                            id="correo"
                                            name="correo"
                                            placeholder="abcd@xxxxx.com"
                                            aria-describedby="defaultFormControlHelp" required
                                        />
                                            <div id="error-correo" class="text-danger"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="inputcodigoOrden" class="form-label">N° Orden</label>
                                            <input type="text" class="form-control" id="inputcodigoOrden" name="ordenId" th:value="${orden.idOrdenes}" aria-describedby="codigoOrdenHelp" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="inputFirstName" class="form-label">Zona</label>
                                            <input type="text" class="form-control" id="inputFirstName" name="zona" th:value="${zona}" aria-describedby="firstNameHelp" readonly>
                                        </div>
                                    </div>
                                
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="inputdirection" class="form-label">Direccion</label>
                                            <input type="text" class="form-control" id="inputdirection" name="direccion" th:value="${direccion}" placeholder="Dirección de envío" aria-describedby="direccionlp" readonly>
                                        </div>
                                    </div>
                                </div>
                        
                                <hr class="m-0" style="margin-bottom:0.5rem">
                                <h3 style="margin-top:0.8rem">Información de Tarjeta</h3>

                                <div class="row g-3">
                                    <input type="hidden" name="ordenId" th:value="${orden.idOrdenes}">
                                    <input type="hidden" name="monto" th:value="${totalGeneral}">
                                    <div class="col-md-20">
                                        <div class="mb-3">
                                            <label for="numeroTarjeta" class="form-label">Numero de Tarjeta</label>
                                            <input type="text" class="form-control" id="numeroTarjeta" name="numeroTarjeta"
                                                   placeholder="xxxx-xxxx-xxxx-xxxx" aria-describedby="inputtarjet" >
                                            <div id="error-numeroTarjeta" class="text-danger"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="inputnombre" class="form-label">Nombre</label>
                                            <input type="text" class="form-control" id="inputnombre" name="nombre" placeholder="Guillermo perez" aria-describedby="inputnombre">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="inputfecha" class="form-label">Fecha</label>
                                            <input type="text" class="form-control" id="inputfecha" name="fechaExpiracion" placeholder="00/00" aria-describedby="inputfecha">
                                            <div id="error-fechaExpiracion" class="text-danger"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="inputcvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="inputcvv" name="codigoCvv" placeholder="XXX" aria-describedby="inputcvv">
                                            <div id="error-codigoCvv" class="text-danger"></div>
                                        </div>
                                    </div>
                                </div>
                                </form>
                            </div>
                        </div>

                        <!-- Sección derecha (40%) -->
                        <div class="col-md-5 my-3 ">
                            <div class="bg-lighter p-6 rounded px-3 py-2 w-100 mx-n2" >
                                <div class="table-responsive">
                                    <table class="table table-bordeless " style="border-collapse: separate; border-spacing: 0;">
                                        <thead>
                                            <tr>
                                                <th>Cantidad</th>
                                                <th>Nombre del Producto</th>
                                                <th>Precio (S/.)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="border-bottom: 1px solid #dee2e6;" th:each="productodeorden : ${productosDeOrden}">
                                                <td th:text="${productodeorden.cantidadComprada}"></td>
                                                <td th:text="${productodeorden.nombreProducto}"></td>
                                                <!--<td th:text="'$' + ${#numbers.formatDecimal(productodeorden.precio, 2)}"></td>-->
                                                <td th:text ="'S/. ' + ${productodeorden.precio}">S/120.00</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Sección para Delivery y Total, alineados a la última columna -->
                                <div class="d-flex justify-content-between align-items-center mt-2 mx-3">
                                    <div></div>
                                    <div class="text-end">
                                        <div>
                                            <span class="fw-bold">Subtotal:</span> S/. <span th:text="${precioSubtotal}">0.00</span>
                                        </div>
                                        <div>
                                            <span class="fw-bold">Delivery:</span> S/.  <span th:text="${deliveryCost}">0.00</span>
                                        </div>
                                        <div>
                                            <span class="fw-bold">Total:</span> S/. <span th:text="${totalGeneral}">0.00</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-center mt-4">
                                    <button type="button" class="btn btn-primary justify-content-center" id="btn-procesar-pago" onclick="procederConPago()">Proceder con el pago</button>
                                </div>
                                <div class="justify-content-center mt-3">
                                    <p>Al aceptar "Proceder con el pago" acepta nuestras Politicas de privacidad de datos del usuario </p>
                                </div>
                            </div>
                            <!-- Aquí puedes añadir el contenido que quieras en el 40% restante -->
                        
                        </div>
                        </div>

                    </div>

                </div>
                
            </div>

        </div>
        <!-- Content wrapper -->
    </div>
    <!-- / Layout page -->
</div>




<!-- Overlay -->
<div class="layout-overlay layout-menu-toggle"></div>
</div>
<!-- / Layout wrapper -->

<!-- Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">¡Felicidades!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Icono de check verde -->
                <div class="icono-check mb-3">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <p>¡El pago ha sido procesado con éxito!</p>
                <p>Por favor, espere a la llegada de su pedido</p>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Descargar</button>
                <button type="button" class="btn btn-success">Finalizar</button>
            </div>
        </div>
    </div>
</div>
  
<script>
    let metodoPagoSeleccionado = null
    document.getElementById("checkbox1").addEventListener("click", function() {
        metodoPagoSeleccionado = "tarjeta";
        this.classList.add("active"); // Añade el estado activo al botón "Tarjeta" (aspecto visual)
        document.getElementById("checkbox2").classList.remove("active"); // Remueve el aspecto visual de "PayPal"
        document.getElementById("checkbox2").checked = false; // deselecciona PayPal si Tarjeta es seleccionada(aspecto de lógica)
        this.checked = true;//marca esta opcion de forma lógica
    });
    document.getElementById("checkbox2").addEventListener("click", function() {
        metodoPagoSeleccionado = "paypal";
        this.classList.add("active");
        document.getElementById("checkbox1").classList.remove("active");
        document.getElementById("checkbox1").checked = false; // deselecciona Tarjeta si PayPal es seleccionada
        this.checked = true;
    });

    function procederConPago() {
        const ordenId = document.querySelector("input[name='ordenId']").value;
        const monto = document.querySelector("input[name='monto']").value;
        const numeroTarjeta = document.getElementById("numeroTarjeta").value;
        const fechaExpiracion = document.getElementById("inputfecha").value;
        const cvv = document.getElementById("inputcvv").value;
        const form = document.getElementById("pagoForm");
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        // Obtener el correo del formulario
        const correoUsuario = document.getElementById("correo").value;
        // Obtener el token CSRF y el nombre del encabezado desde los meta tags
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
        if (metodoPagoSeleccionado === "tarjeta") {
            // Validar los campos de tarjeta antes de enviar
            if (!numeroTarjeta || !fechaExpiracion || !cvv) {
                alert("Por favor, complete los datos de la tarjeta.");
                return;
            }
            /*if (!correoUsuario || !validarCorreo(correoUsuario)) {
                errorCorreo.textContent = "Debe ingresar un correo válido.";
                return; // Detiene la ejecución si el correo no es válido
            }*/

            fetch("/usuario/solicitudpago/tarjeta", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken // Agregar el token CSRF con el encabezado correcto
                },
                /*body: JSON.stringify({
                    ordenId: ordenId,
                    monto: monto,
                    numeroTarjeta: numeroTarjeta,
                    fechaExpiracion: fechaExpiracion,
                    codigoCvv: cvv
                })*/
                body: JSON.stringify(payload),
            })
                .then(response => {
                if (response.status === 400) {
                    return response.json(); // Errores de validación
                } else if (response.ok) {
                    return response.json(); // Éxito
                }
                throw new Error("Error inesperado en el servidor");
            })
                .then(data => {
                    const alertaErrores = document.getElementById("alerta-errores");
                    alertaErrores.classList.add("d-none");
                    /*if (typeof data === 'object') {
                        // Manejar errores de validación
                        mostrarErroresValidacion(data);
                    } else {
                        // Respuesta exitosa
                        alert(data); // Mostrar mensaje de éxito
                        if (data.includes("exitosamente")) {
                            alert("Pago procesado correctamente :).");
                            const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));
                            paymentModal.show();

                            // Enviar boleta y correo después del éxito
                            enviarBoletaYCorreo(correoUsuario, payload);
                        } else {
                            alert("Error inesperado: " + data);
                        }
                    }*/
                    if (data.tarjetaExpirada) {
                        // Mostrar alerta de tarjeta expirada
                        alertaErrores.textContent = data.tarjetaExpirada;
                        alertaErrores.classList.remove("d-none");
                    } else if (data.saldoInsuficiente) {
                        // Mostrar alerta de saldo insuficiente
                        alertaErrores.textContent = data.saldoInsuficiente;
                        alertaErrores.classList.remove("d-none");
                    } else if (data.codigoCvvV){
                        alertaErrores.textContent = data.codigoCvvV;
                        alertaErrores.classList.remove("d-none");
                    }
                    if (data.fechaExpiracion) {
                        // Mostrar error de fecha de expiración directamente debajo del input
                        document.getElementById("error-fechaExpiracion").textContent = data.fechaExpiracion;
                    } else if (data.error) {
                        // Manejar errores específicos del backend
                        alert("Error: " + data.error);
                    } else if (data.message) {
                        // Respuesta exitosa
                        alert(data.message); // Muestra el mensaje "Compra procesada exitosamente"

                        // Muestra el modal de éxito
                        const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));
                        paymentModal.show();

                        // Llama al endpoint para enviar boleta y correo
                        enviarBoletaYCorreo(correoUsuario, payload);
                    } else {
                        mostrarErroresValidacion(data);
                    }
                })
                .catch(error => console.error("Error en el pago con tarjeta:", error));
        } else if (metodoPagoSeleccionado === "paypal") {
            // Realizar el fetch para PayPal
            fetch("/usuario/orden/pago/paypal", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    ordenId: ordenId,
                    monto: monto
                })
            })
                .then(response => response.text())
                .then(result => {
                    alert(result); // Muestra mensaje de éxito o error
                    if (result.includes("exitosamente")) {
                        // Redirigir o actualizar interfaz
                        window.location.href = "/usuario/orden/exito";
                    }
                })
                .catch(error => console.error("Error en el pago con PayPal:", error));
        } else {
            alert("Por favor, seleccione un método de pago antes de continuar.");
        }
    }
</script>
<script>
    // Nueva función para enviar boleta y correo
    function enviarBoletaYCorreo(correo, datosCompra) {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
        fetch("/usuario/orden/procesaryenviar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                ordenId: datosCompra.ordenId,
                correo: correo,
                zona: datosCompra.zona,
                direccion: datosCompra.direccion,
            }),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Error al enviar boleta y correo.");
                }
                return response.text();
            })
            .then((result) => {
                alert("Boleta enviada correctamente a tu correo.");
            })
            .catch((error) => console.error("Error en envío de boleta:", error));
    }

    function mostrarErroresValidacion(errors) {
        // Limpiar mensajes previos
        document.querySelectorAll('.error-message').forEach(e => e.remove());

        // Iterar sobre los errores del backend y asignarlos al input correspondiente
        for (const [field, message] of Object.entries(errors)) {
            const inputField = document.querySelector(`[name="${field}"]`);
            if (inputField) {
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-message";
                errorDiv.style.color = "red";
                errorDiv.textContent = message;
                inputField.parentNode.appendChild(errorDiv);
            }
        }
    }

</script>
  




<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->
<script src="../../assets/vendor/libs/jquery/jquery.js"></script>
<script src="../../assets/vendor/libs/popper/popper.js"></script>
<script src="../../assets/vendor/js/bootstrap.js"></script>
<script src="../../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

<script src="../../assets/vendor/js/menu.js"></script>
<!-- endbuild -->

<!-- Vendors JS -->
<script src="../../assets/vendor/libs/apex-charts/apexcharts.js"></script>

<!-- Main JS -->
<script src="../../assets/js/main.js"></script>

<!-- Page JS -->
<script src="../../assets/js/dashboards-analytics.js"></script>

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<
</body>
</html>
